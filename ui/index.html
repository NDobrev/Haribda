<html>
    <link rel="stylesheet" href="index.css"/>
    <body>
        <div id="left-bar">
            <div onclick='navigateTo("battle", state)'>Battle</div>
            <div onclick='navigateTo("deck", state)'>Deck</div>
            <div onclick='navigateTo("shop", state)'>Shop</div>
            <div onclick='navigateTo("settings", state)'>Settings</div>
        </div>
        <div id="main">

        </div>

        <script>

            const sideTypes = {
                Empty: { id: 0, class: "empty-side"},
                SwordWood: { id: 1, class: "sword-wood-side"},
                ShieldWood: { id: 2, class: "shield-wood-side"},
            }

            const attackDice = [
                sideTypes.SwordWood,
                sideTypes.SwordWood,
                sideTypes.SwordWood,
                sideTypes.SwordWood,
                sideTypes.SwordWood,
                sideTypes.SwordWood,
            ];

            const defenceDice = [
                sideTypes.ShieldWood,
                sideTypes.ShieldWood,
                sideTypes.ShieldWood,
                sideTypes.ShieldWood,
                sideTypes.ShieldWood,
                sideTypes.ShieldWood,
            ];

            const defaultDice = [
                sideTypes.Empty,
                sideTypes.SwordWood,
                sideTypes.SwordWood,
                sideTypes.ShieldWood,
                sideTypes.ShieldWood,
                sideTypes.ShieldWood,
            ];

            let state = {
                player: {
                    health: 100,
                },
                monster: {
                    health: 25,
                    maxHealth: 25,
                },
                currentRoll: [],
                dices: [
                    attackDice,
                    defenceDice,
                    defaultDice,
                ],

                sides: [
                    sideTypes.SwordWood,
                    sideTypes.SwordWood,
                    sideTypes.SwordWood,
                    sideTypes.SwordWood,
                    sideTypes.ShieldWood,
                    sideTypes.ShieldWood,
                    sideTypes.ShieldWood,
                    sideTypes.ShieldWood,
                    sideTypes.ShieldWood,
                ],
                selectedDiceIdx: 0,
                rollStats: [],
            }

            function loadBoard(state) {
                let board = document.createElement("div");
                board.id = "board";
                state.dices.forEach(dice => {
                    board.appendChild(createDice(dice));
                })
                
                return board;
            }

            function loadSkills(target, state) {
                let skills = document.createElement("div");
                skills.id = "skills";
                for (let i = 0; i < 8; ++i) {
                    let skill =  document.createElement("div");
                    skill.id = "slot" + i;
                    skills.appendChild(skill);
                }
                skills.children[0].className = "normal-attack";
                skills.children[0].onclick = attack;
                skills.children[0].textContent = "Attack";
                skills.children[1].className = "shield-block";
                skills.children[1].onclick = defence;
                skills.children[1].textContent = "Defence";
                return skills;
            }

            function loadThrowButton(state) {
                let btn = document.createElement("div");
                btn.id = "throw-button";
                btn.textContent = "Throw";
                btn.onclick = throwDices;
                return btn;
            }
            
            function loadMonster(state) {
                let monster = document.createElement("div");
                monster.id = "monster";
                monster.innerHTML = 
                '<div id="health-bar">'
                + `    <div id="monster-health">${state.monster.health} / ${state.monster.maxHealth}</div>`
                + `    <div id="monster-bar">`
                + `    </div>`
                + `</div>`
                + `<div id="portrait"> </div>`
                return monster;
            }

            function loadBattleScreen(state) {
                console.log("load battle")
                return  [
                    loadBoard(state),
                    loadThrowButton(state),
                    loadSkills(state),
                    loadMonster(state),
                    ];
            }

            function removeSideFromDice(state, sideIdx) {
                let diceIdx = state.selectedDiceIdx;
                let dice = state.dices[diceIdx];
                let side = dice[sideIdx];
                state.sides.push(side);
                dice[sideIdx] = sideTypes.Empty;
                navigateTo("deck", state);
            }

            function addSideToDice(state, sideIdx) {
                let diceIdx = state.selectedDiceIdx;
                let side = state.sides[sideIdx];
                let dice = state.dices[diceIdx];
                for (let i = 0; i < dice.length; ++i) {
                    if (dice[i] == sideTypes.Empty) {
                        state.sides.splice(i, 1);
                        dice[i] = side;
                        break;
                    }
                }
                navigateTo("deck", state);
            }

            function selectDiceForCrafting(state, diceIdx, dice, craft) {
                state.selectedDiceIdx = diceIdx;
                navigateTo("deck", state);
            }

            function loadCraftBoard(state) {
                 let diceIdx = state.selectedDiceIdx;
                 return state.dices[diceIdx].map((side, sideIdx) => {
                    let sideItem = document.createElement("div");
                    sideItem.classList.add("item", side.class);
                    sideItem.textContent = "side " + sideIdx;

                    // add remove button
                    if (side != sideTypes.Empty) {
                        sideItem.onclick = removeSideFromDice.bind(null, state, sideIdx);
                    }

                    return sideItem;
                });
            }

            function loadDeckScreen(state) {
                let board = document.createElement("div");
                board.id = "deck";

                let diceCraft  = document.createElement("div");
                diceCraft.id = "craft";

                let facePicker  = document.createElement("div");
                facePicker.id = "side-picker";

                state.dices.forEach((dice, idx) => {
                    let diceItem = document.createElement("div");
                    diceItem.classList.add("item");
                    diceItem.textContent = "dice" + idx;
                    if (state.selectedDiceIdx == idx) {
                        diceItem.classList.add("item-selected");
                    }
                    diceItem.onclick = selectDiceForCrafting.bind(null,state, idx, diceItem, diceCraft);
                    board.appendChild(diceItem);
                })

                loadCraftBoard(state).forEach(x=> {
                    diceCraft.appendChild(x)
                });


                state.sides.forEach((side, idx) => {
                    let sideItem = document.createElement("div");
                    sideItem.classList.add("item", side.class);
                    sideItem.onclick = addSideToDice.bind(null, state, idx);
                    facePicker.appendChild(sideItem);
                })

                return [board , diceCraft, facePicker];
            }

            function loadShopScreen(state) {
                console.log("load shop")
            }

            function loadSettingScreen(state) {
                console.log("load setting")
            }

            function navigateTo(panel, state) {
                let main = document.getElementById("main");
                main.innerHTML = "";
                let elementsInScreen;
                switch(panel) {
                    case "battle":
                    elementsInScreen = loadBattleScreen(state);
                    break;
                    case "deck":
                    elementsInScreen = loadDeckScreen(state);
                    break;
                    case "shop":
                    elementsInScreen = loadShopScreen(state);
                    break;
                    case "settings":
                    elementsInScreen = loadSettingScreen(state);
                    break;
                }
                if (elementsInScreen instanceof Array) {
                    elementsInScreen.forEach(x => main.appendChild(x));
                } else if (elementsInScreen instanceof HTMLElement) {
                    main.appendChild(elementsInScreen);
                } else {
                    console.error(`${panel} can't be loaded`);
                }
            }

            navigateTo("deck", state);


            function createDice(diceSides) {
                let create = (...arguments) => {
                    let r = document.createElement("div");
                    r.classList.add(...arguments);
                    return r;
                }

                let cube = create("cube");
                cube.appendChild(create("face", "front", diceSides[0].class));
                cube.appendChild(create("face", "back", diceSides[1].class));
                cube.appendChild(create("face", "right",  diceSides[2].class));
                cube.appendChild(create("face", "left",  diceSides[3].class));
                cube.appendChild(create("face", "top",  diceSides[4].class));
                cube.appendChild(create("face", "bottom",  diceSides[5].class));

                let dice = create("container");
                dice.appendChild(cube);
                return dice;
            }

            function attack() {
                console.log("attack" + state.rollStats[sideTypes.SwordWood.id]);
                state.monster.health -= state.rollStats[sideTypes.SwordWood.id];
                
                state.monster.health = Math.max(0, state.monster.health);
                
                console.log("monster", state.monster);


                let monsterHealth = document.getElementById("monster-health");
                let monsterHealthBar = document.getElementById("monster-bar");
                monsterHealthBar.style.width = 100 * (state.monster.health / state.monster.maxHealth) + '%';
                monsterHealth.textContent = `${state.monster.health} / ${state.monster.maxHealth}`;
                if (state.monster.health == 0) {
                    console.log("Monster is dead");
                    setTimeout(function() {
                        state.monster.maxHealth = Math.floor(state.monster.maxHealth * 1.2);
                        state.monster.health = state.monster.maxHealth;
                        monsterHealthBar.style.width = 100 * (state.monster.health / state.monster.maxHealth) + '%';
                        monsterHealth.textContent = `${state.monster.health} / ${state.monster.maxHealth}`;
                    }, 1000);
                }
            }

            function defence() {
                console.log("def" + state.rollStats[sideTypes.ShieldWood.id]);
            }

            function calcRollStats(rolls) {
                return rolls.reduce((stats, roll) => {
                    stats[defaultDice[roll].id]++;
                    return stats;
                },  [0, 0, 0]);
            }

            function throwDices() {
                let dices = document.getElementsByClassName("cube");
                let faces = [
                    [0, 0, 0], // 1
                    [180, 0, 0], // 2
                    [0, 270, 0], // 3
                    [0, 90, 0], // 4
                    [270, 0, 0], // 5
                    [90, 0, 0], // 6
                ]
                state.currentRoll = [];
                for (let dice of dices) {
                    let faceId = Math.floor(Math.random() * faces.length);
                    let face = faces[faceId].map(x => x + 360 * Math.round(Math.random() * 3 + 1));
                    dice.style.transform = `rotateX(${face[0]}deg) rotateY(${face[1]}deg) rotateZ(${face[2]}deg)`;
                    dice.style.transition = 0.5 + Math.random() * 4 + 's';
                    state.currentRoll.push(faceId);
                }
                console.log(state.currentRoll);
                console.log(calcRollStats(state.currentRoll));
                state.rollStats = calcRollStats(state.currentRoll);
            }

            let tick = (now) => {
                requestAnimationFrame(tick);
            }
            requestAnimationFrame(tick);
        </script>
    </body>
</html>